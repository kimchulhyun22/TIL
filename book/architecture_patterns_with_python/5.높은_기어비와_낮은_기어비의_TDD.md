# 5장 높은 기어비와 낮은 기어비의 TDD

서비스 계층을 사용하면 각각의 유스 케이스와 워크플로를 명확히 정의할 때 도움이 된다. 정의할 수 있는 내용으로는 저장소에서 얻을 필요가 있는 데이터가 무엇인지, 어떤 사전 검사와 현재 상태 검증을 필수적으로 해야 할지, 마지막에 어떤 내용을 저장할지 등이 있다.

저수준에서 작동하며 모델과 직접 작용하는 테스트를 고수준으로 끌어올렸을 때 발생하는 트레이드오프에 대해 알아본다.

---

## 도메인 계층 테스트을 시비스 계층으로 옮겨야 하는가?

서비스 계층에 대해 소프트웨어를 테스트한다면 도메인 모델 테스트가 필요없다. 따라서 모든 도메인 수준의 테스트를 서비스 계층에 대한 테스트로 재작성한다.

그 이유는 도메인 모델에 대해 테스트를 너무 많이 작성한다면 코드 베이스를 바꿀 때마다 수십 개에서 수백 개의 테스트를 변경해야 한다. 고수준의 테스트를 작성할수록 도메인 모델을 리팩터링할 때 변경해야 하는 코드의 양을 줄일 수 있다. 

---

## 결합과 설계 피드백 사이의 트레이드 오프

#### API 테스트
- 피드백 적음
- 변경 장벽 낮음
- 더 넓은 시스템 테스트

#### 도메인 테스트
- 피드백 많음
- 변경 장벽 높음
- 한정된 영역 테스트


테스트가 고수준일수록 테스트는 용이해지지만 필요한 객체나 도메인 모델에 대한 이해가 어려워진다. 이와 반대로 저수준일수록 테스트를 읽고 시스템이 어떻게 동작하는지 빠르게 이해하고 핵심 개념이 어떻게 연관됐는지 이해할 수 있다. 하지만 특정 구현과 긴밀하게 결합되어 있어서 코드 디자인을 개선하려면 이런 테스트를 다른 테스트로 대치하거나 삭제해야 한다.


---

## 높은 기어비와 낮은 기어비

새로운 기능을 추가하거나 버그를 수정할 때 도메인 모델을 크게 변경할 필요가 없다. 도메인 모델을 변경해야 하는 경우 더 낮은 결합과 더 높은 커버리지를 제공하므로 서비스에 대한 테스트를 작성하는 게 좋다.

하지만 새로운 프로젝트를 시작하거나 아주 어려운 특정 문제를 다뤄야 한다면 도메인 모델에 대한 테스트를 다시 작성해서 더 나은 피드백을 얻고 의도를 더 명확히 설명하는 실행 가능한 문서를 얻을 수 있다. 

은유적으로 표현하여 변속기어를 조정해 기어비를 변경하는 것이다. 여행을 시작할 때 자전거 기어를 저단(낮은 기어비)에 둬야 관성을 이길 수 있지만 자전거가 빠르게 움직이기 시작하면 더 높은 기어비로 바꿔야 더 효율적으로 움직일 수 있다. 하지만 갑자기 급경사를 마주하거나 위험한 장애물이 있어서 속도를 강제로 낮춰야 한다면 다시 기어비를 낮춰야 한다.

---

